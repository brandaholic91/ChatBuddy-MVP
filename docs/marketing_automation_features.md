# Marketing Automation & Kos√°relhagy√°s Follow-up

## üõí √Åttekint√©s

A Chatbuddy MVP marketing automation rendszere intelligens follow-up √ºzenetekkel seg√≠ti a v√°s√°rl√≥k visszat√©r√©s√©t √©s n√∂veli a konverzi√≥s r√°t√°kat. A rendszer automatikusan felismeri a kos√°relhagy√°st √©s szem√©lyre szabott √ºzeneteket k√ºld multiple csatorn√°kon kereszt√ºl.

---

## üéØ **F≈ëbb Funkci√≥k**

### **üîç Abandoned Cart Detection**
- **Automatikus felismer√©s**: Session inaktivit√°s alap√∫ kos√°relhagy√°s detekt√°l√°s
- **Intelligens timing**: 30 perc inaktivit√°s ut√°n trigger aktiv√°l√°s
- **Kos√°r √©rt√©kel√©s**: Minim√°lis kos√°r√©rt√©k alap√∫ prioriz√°ci√≥
- **User behavior tracking**: Visszat√©r√©si mint√°k elemz√©se

### **üìß Multi-Channel Follow-up**
- **Email automation**: Szem√©lyre szabott HTML email sablonok
- **SMS notifications**: R√∂vid, s√ºrget≈ë √ºzenetek mobilon
- **In-app chat**: Visszat√©r≈ë felhaszn√°l√≥k √ºdv√∂zl√©se chatbot-ban
- **Facebook Messenger**: Interakt√≠v √ºzenetek √©s carousel k√°rty√°k
- **WhatsApp Business**: Gazdag m√©diatartalom √©s quick reply gombok
- **Push notifications**: Browser push √©rtes√≠t√©sek (j√∂v≈ëbeli b≈ëv√≠t√©s)

### **üåê Social Media Integration**
- **Facebook Messenger Platform**: Template messages, generic templates, quick replies
- **WhatsApp Business API**: Interactive messages, media messages, template messages
- **Cross-platform messaging**: Egys√©ges √ºzenet delivery minden csatorn√°n
- **Social CRM**: Messenger √©s WhatsApp conversation tracking

### **üé® Szem√©lyre Szab√°s**
- **Dynamic content**: Term√©kk√©pek √©s -le√≠r√°sok beilleszt√©se
- **Pricing intelligence**: Dinamikus kedvezm√©nyek √©s aj√°nlatok
- **Behavioral targeting**: M√∫ltbeli v√°s√°rl√°sok alap√∫ aj√°nl√°sok
- **Segmentation**: V√°s√°rl√≥i csoportok alap√∫ √ºzenet testreszab√°s

---

## üèóÔ∏è **Architekt√∫ra √©s Implement√°ci√≥**

### **1. Marketing Automation Agent**

```python
from dataclasses import dataclass
from pydantic_ai import Agent, RunContext
from pydantic import BaseModel
from datetime import datetime, timedelta
from typing import List, Optional
import asyncio

@dataclass
class MarketingDependencies:
    """Marketing automation √ºgyn√∂k f√ºgg≈ës√©gei"""
    supabase_client: Any
    email_service: Any      # SendGrid integration
    sms_service: Any        # Twilio integration  
    messenger_service: Any  # Facebook Messenger API
    whatsapp_service: Any   # WhatsApp Business API
    webshop_api: Any
    template_engine: Any    # Jinja2 templates
    user_context: dict

class AbandonedCartEvent(BaseModel):
    """Kos√°relhagy√°s esem√©ny modell"""
    cart_id: str = Field(..., description="Kos√°r egyedi azonos√≠t√≥")
    customer_id: str = Field(..., description="√úgyf√©l azonos√≠t√≥")
    session_id: str = Field(..., description="Session azonos√≠t√≥")
    abandoned_at: datetime = Field(..., description="Elhagy√°s id≈ëpontja")
    cart_value: float = Field(..., ge=0, description="Kos√°r √©rt√©ke")
    items: List[dict] = Field(..., description="Kos√°r elemek list√°ja")
    customer_email: Optional[str] = Field(None, description="√úgyf√©l email c√≠me")
    customer_phone: Optional[str] = Field(None, description="√úgyf√©l telefonsz√°ma")
    follow_up_attempts: int = Field(default=0, description="K√ºld√∂tt eml√©keztet≈ëk sz√°ma")
    returned: bool = Field(default=False, description="Visszat√©rt-e a v√°s√°rl√≥")

class FollowUpCampaign(BaseModel):
    """Follow-up kamp√°ny konfigur√°ci√≥s modell"""
    campaign_type: str = Field(..., description="Kamp√°ny t√≠pusa")
    trigger_delay_minutes: int = Field(..., description="Trigger k√©s√©s percekben")
    message_template: str = Field(..., description="√úzenet sablon azonos√≠t√≥")
    discount_percentage: Optional[float] = Field(None, description="Kedvezm√©ny sz√°zal√©k")
    max_attempts: int = Field(default=3, description="Maximum pr√≥b√°lkoz√°sok")
    active: bool = Field(default=True, description="Kamp√°ny akt√≠v st√°tusza")

# Marketing Automation Agent inicializ√°l√°sa
marketing_agent = Agent(
    'openai:gpt-4o',
    deps_type=MarketingDependencies,
    system_prompt="""
    Te egy marketing automation specialista vagy, aki seg√≠ti a v√°s√°rl√≥knak visszat√©rni √©s befejezni a v√°s√°rl√°sukat.
    
    Feladataid:
    - Kos√°relhagy√°s felismer√©se √©s follow-up √ºzenetek k√ºld√©se
    - Szem√©lyre szabott aj√°nlatok √©s kedvezm√©nyek gener√°l√°sa  
    - V√°s√°rl√≥i visszat√©r√©s optimaliz√°l√°sa
    - Marketing kamp√°nyok eredm√©nyess√©g√©nek k√∂vet√©se
    
    Mindig bar√°ts√°gos, seg√≠t≈ëk√©sz √©s nem tolakod√≥ hangnemet haszn√°lj.
    A magyar v√°s√°rl√≥i szok√°sokat √©s kult√∫r√°t vedd figyelembe.
    """
)
```

### **2. Core Tools √©s Funkci√≥k**

```python
@marketing_agent.tool
async def detect_abandoned_cart(
    ctx: RunContext[MarketingDependencies],
    session_id: str,
    threshold_minutes: int = 30
) -> Optional[AbandonedCartEvent]:
    """Kos√°relhagy√°s automatikus felismer√©se"""
    
    # Session utols√≥ aktivit√°s ellen≈ërz√©se
    session = await ctx.deps.supabase_client.table('user_sessions').select('*').eq('session_id', session_id).single().execute()
    
    if not session.data:
        return None
    
    last_activity = datetime.fromisoformat(session.data['last_activity'])
    time_inactive = (datetime.now() - last_activity).total_seconds() / 60
    
    if time_inactive < threshold_minutes:
        return None
    
    # Kos√°r tartalom lek√©r√©se
    cart_items = await ctx.deps.webshop_api.get_cart_items(session_id)
    
    if not cart_items or len(cart_items) == 0:
        return None
    
    # Kos√°r √©rt√©k kalkul√°ci√≥
    total_value = sum(item['price'] * item['quantity'] for item in cart_items)
    
    # Minimum kos√°r√©rt√©k ellen≈ërz√©s (pl. 5000 Ft felett)
    if total_value < 5000:
        return None
    
    # Abandoned cart event l√©trehoz√°sa
    abandoned_event = AbandonedCartEvent(
        cart_id=f"cart_{session_id}",
        customer_id=session.data.get('customer_id', 'anonymous'),
        session_id=session_id,
        abandoned_at=datetime.now(),
        cart_value=total_value,
        items=cart_items,
        customer_email=session.data.get('customer_email'),
        customer_phone=session.data.get('customer_phone')
    )
    
    # Esem√©ny ment√©se adatb√°zisba
    await ctx.deps.supabase_client.table('abandoned_carts').insert(abandoned_event.dict()).execute()
    
    return abandoned_event

@marketing_agent.tool
async def send_follow_up_email(
    ctx: RunContext[MarketingDependencies],
    abandoned_cart: AbandonedCartEvent,
    template_name: str = 'abandoned_cart_reminder'
) -> bool:
    """Szem√©lyre szabott follow-up email k√ºld√©se"""
    
    if not abandoned_cart.customer_email:
        return False
    
    # Email sablon renderel√©se
    template_data = {
        'customer_name': await get_customer_name(ctx, abandoned_cart.customer_id),
        'cart_items': abandoned_cart.items,
        'cart_total': f"{abandoned_cart.cart_value:,.0f} Ft",
        'return_url': f"https://webshop.com/cart/restore/{abandoned_cart.cart_id}",
        'discount_code': await generate_discount_code(ctx, abandoned_cart.customer_id)
    }
    
    email_content = await ctx.deps.template_engine.render(
        template_name, 
        **template_data
    )
    
    # Email k√ºld√©s SendGrid-del
    success = await ctx.deps.email_service.send_email(
        to_email=abandoned_cart.customer_email,
        subject="üõí Ne felejtsd el! V√°r r√°d a kosaradban...",
        html_content=email_content
    )
    
    if success:
        # Follow-up attempt tracking
        await ctx.deps.supabase_client.table('abandoned_carts').update({
            'follow_up_attempts': abandoned_cart.follow_up_attempts + 1,
            'last_follow_up': datetime.now().isoformat()
        }).eq('cart_id', abandoned_cart.cart_id).execute()
    
    return success

@marketing_agent.tool  
async def send_follow_up_sms(
    ctx: RunContext[MarketingDependencies],
    abandoned_cart: AbandonedCartEvent
) -> bool:
    """R√∂vid SMS eml√©keztet≈ë k√ºld√©se"""
    
    if not abandoned_cart.customer_phone:
        return False
    
    # SMS sablon personaliz√°l√°sa
    customer_name = await get_customer_name(ctx, abandoned_cart.customer_id)
    discount_code = await generate_discount_code(ctx, abandoned_cart.customer_id)
    
    sms_message = f"""
    Szia {customer_name}! üõí 
    
    {abandoned_cart.cart_value:,.0f} Ft √©rt√©kben maradt valami a kosaradban.
    
    Haszn√°ld a {discount_code} k√≥dot 10% kedvezm√©ny√©rt!
    
    V√°s√°rl√°s befejez√©se: https://short.ly/cart/{abandoned_cart.cart_id}
    """
    
    # SMS k√ºld√©s Twilio-val
    success = await ctx.deps.sms_service.send_sms(
        to_phone=abandoned_cart.customer_phone,
        message=sms_message.strip()
    )
    
    return success

@marketing_agent.tool
async def send_messenger_follow_up(
    ctx: RunContext[MarketingDependencies],
    abandoned_cart: AbandonedCartEvent
) -> bool:
    """Facebook Messenger interakt√≠v √ºzenet k√ºld√©se"""
    
    messenger_id = await get_customer_messenger_id(ctx, abandoned_cart.customer_id)
    if not messenger_id:
        return False
    
    customer_name = await get_customer_name(ctx, abandoned_cart.customer_id)
    discount_code = await generate_discount_code(ctx, abandoned_cart.customer_id)
    
    # Facebook Messenger carousel √ºzenet template
    messenger_payload = {
        "recipient": {"id": messenger_id},
        "message": {
            "attachment": {
                "type": "template",
                "payload": {
                    "template_type": "generic",
                    "elements": [
                        {
                            "title": f"Szia {customer_name}! üõí",
                            "subtitle": f"{abandoned_cart.cart_value:,.0f} Ft maradt a kosaradban",
                            "image_url": "https://your-domain.com/cart-reminder.jpg",
                            "buttons": [
                                {
                                    "type": "web_url",
                                    "url": f"https://webshop.com/cart/restore/{abandoned_cart.cart_id}",
                                    "title": "V√°s√°rl√°s befejez√©se üõçÔ∏è"
                                },
                                {
                                    "type": "postback",
                                    "title": f"üéÅ {discount_code} k√≥d haszn√°lata",
                                    "payload": f"USE_DISCOUNT_{discount_code}"
                                }
                            ]
                        }
                    ]
                }
            }
        }
    }
    
    # Facebook Messenger API h√≠v√°s
    success = await ctx.deps.messenger_service.send_message(messenger_payload)
    
    if success:
        # Messenger follow-up tracking
        await ctx.deps.supabase_client.table('abandoned_carts').update({
            'messenger_sent': True,
            'messenger_sent_at': datetime.now().isoformat()
        }).eq('cart_id', abandoned_cart.cart_id).execute()
    
    return success

@marketing_agent.tool
async def send_whatsapp_follow_up(
    ctx: RunContext[MarketingDependencies],
    abandoned_cart: AbandonedCartEvent
) -> bool:
    """WhatsApp Business interakt√≠v √ºzenet k√ºld√©se"""
    
    whatsapp_number = await get_customer_whatsapp(ctx, abandoned_cart.customer_id)
    if not whatsapp_number:
        return False
    
    customer_name = await get_customer_name(ctx, abandoned_cart.customer_id)
    discount_code = await generate_discount_code(ctx, abandoned_cart.customer_id)
    
    # WhatsApp Business API template message
    whatsapp_payload = {
        "messaging_product": "whatsapp",
        "to": whatsapp_number,
        "type": "template",
        "template": {
            "name": "abandoned_cart_hu",  # Pre-approved WhatsApp template
            "language": {
                "code": "hu"
            },
            "components": [
                {
                    "type": "header",
                    "parameters": [
                        {
                            "type": "image",
                            "image": {
                                "link": "https://your-domain.com/cart-image.jpg"
                            }
                        }
                    ]
                },
                {
                    "type": "body",
                    "parameters": [
                        {
                            "type": "text",
                            "text": customer_name
                        },
                        {
                            "type": "text", 
                            "text": f"{abandoned_cart.cart_value:,.0f}"
                        },
                        {
                            "type": "text",
                            "text": discount_code
                        }
                    ]
                },
                {
                    "type": "button",
                    "sub_type": "url",
                    "index": "0",
                    "parameters": [
                        {
                            "type": "text",
                            "text": abandoned_cart.cart_id
                        }
                    ]
                }
            ]
        }
    }
    
    # Alternative: Interactive message with quick replies
    interactive_payload = {
        "messaging_product": "whatsapp",
        "to": whatsapp_number,
        "type": "interactive",
        "interactive": {
            "type": "button",
            "header": {
                "type": "text",
                "text": f"üõí Szia {customer_name}!"
            },
            "body": {
                "text": f"{abandoned_cart.cart_value:,.0f} Ft √©rt√©kben maradt valami a kosaradban.\n\nüéÅ Haszn√°ld a *{discount_code}* k√≥dot 10% kedvezm√©ny√©rt!"
            },
            "footer": {
                "text": "Webshop csapata"
            },
            "action": {
                "buttons": [
                    {
                        "type": "reply",
                        "reply": {
                            "id": f"complete_cart_{abandoned_cart.cart_id}",
                            "title": "üõçÔ∏è V√°s√°rl√°s befejez√©se"
                        }
                    },
                    {
                        "type": "reply",
                        "reply": {
                            "id": f"use_discount_{discount_code}",
                            "title": f"üéÅ {discount_code} haszn√°lata"
                        }
                    },
                    {
                        "type": "reply",
                        "reply": {
                            "id": "remind_later",
                            "title": "‚è∞ Eml√©keztess k√©s≈ëbb"
                        }
                    }
                ]
            }
        }
    }
    
    # WhatsApp Business API h√≠v√°s (interactive message prefer√°lt)
    success = await ctx.deps.whatsapp_service.send_message(interactive_payload)
    
    if success:
        # WhatsApp follow-up tracking
        await ctx.deps.supabase_client.table('abandoned_carts').update({
            'whatsapp_sent': True,
            'whatsapp_sent_at': datetime.now().isoformat()
        }).eq('cart_id', abandoned_cart.cart_id).execute()
    
    return success

@marketing_agent.tool
async def handle_cart_return(
    ctx: RunContext[MarketingDependencies],
    cart_id: str,
    customer_id: str
) -> str:
    """Visszat√©r≈ë v√°s√°rl√≥ √ºdv√∂zl√©se"""
    
    # Kos√°r vissza√°ll√≠t√°sa
    cart_restored = await ctx.deps.webshop_api.restore_cart(cart_id)
    
    if cart_restored:
        # Abandoned cart esem√©ny lez√°r√°sa
        await ctx.deps.supabase_client.table('abandoned_carts').update({
            'returned': True,
            'returned_at': datetime.now().isoformat()
        }).eq('cart_id', cart_id).execute()
        
        return """
        üéâ √ñr√ºl√∂k, hogy visszat√©rt√©l! 
        
        Vissza√°ll√≠tottam a kosaradat. Van egy kis meglepet√©sem sz√°modra - 
        haszn√°ld a WELCOME10 k√≥dot 10% kedvezm√©ny√©rt!
        
        Seg√≠thetek befejezni a rendel√©st?
        """
    
    return "Sajnos nem siker√ºlt vissza√°ll√≠tani a kosaradat. Seg√≠tek √∫jra √∂ssze√°ll√≠tani?"

@marketing_agent.tool
async def generate_personalized_offers(
    ctx: RunContext[MarketingDependencies],
    customer_id: str,
    abandoned_items: List[dict]
) -> List[dict]:
    """Szem√©lyre szabott aj√°nlatok gener√°l√°sa"""
    
    # V√°s√°rl√°si el≈ëzm√©nyek elemz√©se
    purchase_history = await ctx.deps.webshop_api.get_customer_history(customer_id)
    
    # Hasonl√≥ term√©kek keres√©se vector search-el
    recommendations = []
    for item in abandoned_items:
        similar_products = await ctx.deps.vector_db.similarity_search(
            f"{item['name']} {item['category']}", 
            limit=3
        )
        recommendations.extend(similar_products)
    
    # Aj√°nlatok szem√©lyre szab√°sa
    personalized_offers = []
    for product in recommendations:
        offer = {
            'product_id': product['id'],
            'product_name': product['name'],
            'original_price': product['price'],
            'discounted_price': product['price'] * 0.9,  # 10% kedvezm√©ny
            'reason': 'Hasonl√≥ term√©k, amit m√°sok is v√°s√°roltak',
            'urgency': 'Limit√°lt idej≈± aj√°nlat - csak 24 √≥r√°n √°t!'
        }
        personalized_offers.append(offer)
    
    return personalized_offers[:5]  # Top 5 aj√°nlat
```

### **3. Social Media Communication Agent**

```python
from dataclasses import dataclass
from pydantic_ai import Agent, RunContext
from typing import Dict, Any, Optional

@dataclass
class SocialMediaDependencies:
    """Social media kommunik√°ci√≥s √ºgyn√∂k f√ºgg≈ës√©gei"""
    messenger_api: Any      # Facebook Messenger Platform API
    whatsapp_api: Any       # WhatsApp Business API
    supabase_client: Any
    template_engine: Any
    user_context: dict

class SocialMediaMessage(BaseModel):
    """Social media √ºzenet modell"""
    platform: str = Field(..., description="Platform: messenger/whatsapp")
    recipient_id: str = Field(..., description="C√≠mzett azonos√≠t√≥")
    message_type: str = Field(..., description="√úzenet t√≠pus: text/template/interactive")
    content: Dict[str, Any] = Field(..., description="√úzenet tartalma")
    metadata: Optional[Dict[str, Any]] = Field(None, description="Tov√°bbi metaadatok")

# Social Media Communication Agent
social_media_agent = Agent(
    'openai:gpt-4o',
    deps_type=SocialMediaDependencies,
    system_prompt="""
    Te egy social media kommunik√°ci√≥s specialista vagy. A feladatod:
    
    - Facebook Messenger √©s WhatsApp √ºzenetek kezel√©se
    - Interakt√≠v √ºzenetek √©s template-ek l√©trehoz√°sa
    - Cross-platform conversation tracking
    - Customer engagement optimaliz√°l√°sa
    
    Minden √ºzenet legyen bar√°ts√°gos, seg√≠t≈ëk√©sz √©s a magyar kult√∫r√°nak megfelel≈ë.
    Haszn√°lj emoji-kat √©s interakt√≠v elemeket a jobb user experience √©rdek√©ben.
    """
)

@social_media_agent.tool
async def handle_messenger_webhook(
    ctx: RunContext[SocialMediaDependencies],
    webhook_data: Dict[str, Any]
) -> str:
    """Facebook Messenger webhook esem√©ny kezel√©se"""
    
    for entry in webhook_data.get('entry', []):
        for messaging in entry.get('messaging', []):
            sender_id = messaging['sender']['id']
            
            # Postback esem√©nyek kezel√©se (gomb kattint√°sok)
            if 'postback' in messaging:
                payload = messaging['postback']['payload']
                
                if payload.startswith('USE_DISCOUNT_'):
                    discount_code = payload.replace('USE_DISCOUNT_', '')
                    return await handle_discount_activation(ctx, sender_id, discount_code)
                
                elif payload.startswith('COMPLETE_CART_'):
                    cart_id = payload.replace('COMPLETE_CART_', '')
                    return await handle_cart_completion_guide(ctx, sender_id, cart_id)
            
            # Quick reply esem√©nyek kezel√©se
            elif 'message' in messaging and 'quick_reply' in messaging['message']:
                quick_reply_payload = messaging['message']['quick_reply']['payload']
                return await handle_quick_reply(ctx, sender_id, quick_reply_payload)
            
            # Sz√∂veges √ºzenetek kezel√©se
            elif 'message' in messaging and 'text' in messaging['message']:
                user_message = messaging['message']['text']
                return await handle_messenger_text(ctx, sender_id, user_message)
    
    return "Webhook processed successfully"

@social_media_agent.tool
async def handle_whatsapp_webhook(
    ctx: RunContext[SocialMediaDependencies],
    webhook_data: Dict[str, Any]
) -> str:
    """WhatsApp Business webhook esem√©ny kezel√©se"""
    
    for entry in webhook_data.get('entry', []):
        for change in entry.get('changes', []):
            if change.get('field') == 'messages':
                for message in change.get('value', {}).get('messages', []):
                    sender_number = message['from']
                    
                    # Interactive message button click
                    if message.get('type') == 'interactive':
                        button_reply = message['interactive']['button_reply']
                        button_id = button_reply['id']
                        
                        if button_id.startswith('complete_cart_'):
                            cart_id = button_id.replace('complete_cart_', '')
                            return await handle_whatsapp_cart_completion(ctx, sender_number, cart_id)
                        
                        elif button_id.startswith('use_discount_'):
                            discount_code = button_id.replace('use_discount_', '')
                            return await handle_whatsapp_discount(ctx, sender_number, discount_code)
                    
                    # Text message
                    elif message.get('type') == 'text':
                        user_message = message['text']['body']
                        return await handle_whatsapp_text(ctx, sender_number, user_message)
    
    return "WhatsApp webhook processed successfully"

@social_media_agent.tool
async def create_messenger_product_carousel(
    ctx: RunContext[SocialMediaDependencies],
    recipient_id: str,
    products: List[Dict[str, Any]]
) -> bool:
    """Facebook Messenger term√©k carousel l√©trehoz√°sa"""
    
    elements = []
    for product in products[:10]:  # Max 10 elem carousel-ben
        element = {
            "title": product['name'],
            "subtitle": f"{product['price']:,.0f} Ft ‚Ä¢ {product.get('description', '')[:80]}...",
            "image_url": product.get('image_url', 'https://via.placeholder.com/300x200'),
            "default_action": {
                "type": "web_url",
                "url": product['url'],
                "messenger_extensions": True,
                "webview_height_ratio": "tall"
            },
            "buttons": [
                {
                    "type": "web_url",
                    "url": product['url'],
                    "title": "üõçÔ∏è Megtekint√©s"
                },
                {
                    "type": "postback",
                    "title": "üì¶ Kos√°rba",
                    "payload": f"ADD_TO_CART_{product['id']}"
                }
            ]
        }
        elements.append(element)
    
    carousel_payload = {
        "recipient": {"id": recipient_id},
        "message": {
            "attachment": {
                "type": "template",
                "payload": {
                    "template_type": "generic",
                    "elements": elements
                }
            }
        }
    }
    
    success = await ctx.deps.messenger_api.send_message(carousel_payload)
    return success

@social_media_agent.tool
async def create_whatsapp_product_list(
    ctx: RunContext[SocialMediaDependencies],
    recipient_number: str,
    products: List[Dict[str, Any]]
) -> bool:
    """WhatsApp interakt√≠v term√©k lista l√©trehoz√°sa"""
    
    sections = [{
        "title": "Kiemelt term√©kek",
        "rows": []
    }]
    
    for product in products[:10]:  # Max 10 term√©k
        row = {
            "id": f"product_{product['id']}",
            "title": product['name'][:24],  # WhatsApp title limit
            "description": f"{product['price']:,.0f} Ft ‚Ä¢ {product.get('description', '')[:72]}"
        }
        sections[0]["rows"].append(row)
    
    list_payload = {
        "messaging_product": "whatsapp",
        "to": recipient_number,
        "type": "interactive",
        "interactive": {
            "type": "list",
            "header": {
                "type": "text",
                "text": "üõçÔ∏è Term√©kaj√°nlataink"
            },
            "body": {
                "text": "V√°lassz a kedvenc term√©keid k√∂z√ºl! Minden term√©kre ingyenes sz√°ll√≠t√°s √©s 30 napos visszavitel."
            },
            "footer": {
                "text": "Webshop csapata"
            },
            "action": {
                "button": "Term√©kek megtekint√©se",
                "sections": sections
            }
        }
    }
    
    success = await ctx.deps.whatsapp_api.send_message(list_payload)
    return success
```

### **4. Background Task System**

```python
from celery import Celery
import asyncio

# Celery app inicializ√°l√°sa
celery_app = Celery('marketing_automation')
celery_app.config_from_object('celery_config')

@celery_app.task
async def abandoned_cart_workflow(cart_id: str):
    """Automatikus kos√°relhagy√°s follow-up workflow"""
    
    # 30 perc v√°rakoz√°s
    await asyncio.sleep(30 * 60)
    
    # Els≈ë eml√©keztet≈ë email
    abandoned_cart = await get_abandoned_cart(cart_id)
    if abandoned_cart and not abandoned_cart.returned:
        await marketing_agent.run(
            f"K√ºldj follow-up emailt a {cart_id} kos√°rhoz",
            deps=marketing_deps
        )
    
    # 2 √≥ra v√°rakoz√°s
    await asyncio.sleep(2 * 60 * 60)
    
    # SMS eml√©keztet≈ë kedvezm√©nnyel
    if abandoned_cart and not abandoned_cart.returned:
        await marketing_agent.run(
            f"K√ºldj SMS eml√©keztet≈ët kedvezm√©nnyel a {cart_id} kos√°rhoz",
            deps=marketing_deps
        )
    
    # 24 √≥ra v√°rakoz√°s  
    await asyncio.sleep(24 * 60 * 60)
    
    # V√©gs≈ë aj√°nlat nagyobb kedvezm√©nnyel
    if abandoned_cart and not abandoned_cart.returned:
        await marketing_agent.run(
            f"K√ºldj v√©gs≈ë aj√°nlatot 20% kedvezm√©nnyel a {cart_id} kos√°rhoz",
            deps=marketing_deps
        )

@celery_app.task
def trigger_abandoned_cart_detection():
    """Rendszeres kos√°relhagy√°s detekt√°l√°s (minden 15 percben)"""
    active_sessions = get_active_sessions()
    
    for session in active_sessions:
        abandoned_cart_workflow.delay(session['session_id'])
```

---

## üõ†Ô∏è **Adatb√°zis Schema B≈ëv√≠t√©sek**

### **Supabase T√°bla Defin√≠ci√≥k**

```sql
-- Kos√°relhagy√°s esem√©nyek t√°rol√°sa (Social Media Support)
CREATE TABLE abandoned_carts (
    id SERIAL PRIMARY KEY,
    cart_id TEXT UNIQUE NOT NULL,
    customer_id TEXT,
    session_id TEXT NOT NULL,
    abandoned_at TIMESTAMP NOT NULL DEFAULT NOW(),
    cart_value DECIMAL(10,2) NOT NULL,
    items JSONB NOT NULL,
    customer_email TEXT,
    customer_phone TEXT,
    customer_messenger_id TEXT,        -- Facebook Messenger PSID
    customer_whatsapp TEXT,            -- WhatsApp Business number
    follow_up_attempts INTEGER DEFAULT 0,
    last_follow_up TIMESTAMP,
    email_sent BOOLEAN DEFAULT FALSE,
    email_sent_at TIMESTAMP,
    sms_sent BOOLEAN DEFAULT FALSE,
    sms_sent_at TIMESTAMP,
    messenger_sent BOOLEAN DEFAULT FALSE,  -- Facebook Messenger k√ºld√©s
    messenger_sent_at TIMESTAMP,
    whatsapp_sent BOOLEAN DEFAULT FALSE,   -- WhatsApp k√ºld√©s
    whatsapp_sent_at TIMESTAMP,
    returned BOOLEAN DEFAULT FALSE,
    returned_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Marketing kamp√°nyok konfigur√°ci√≥ja
CREATE TABLE marketing_campaigns (
    id SERIAL PRIMARY KEY,
    campaign_name TEXT NOT NULL,
    campaign_type TEXT NOT NULL, -- 'abandoned_cart', 'product_recommendation', 'seasonal'
    trigger_rules JSONB NOT NULL,
    message_templates JSONB NOT NULL,
    scheduling_config JSONB,
    active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Email/SMS √ºzenet k√ºld√©si log
CREATE TABLE marketing_messages (
    id SERIAL PRIMARY KEY,
    campaign_id INTEGER REFERENCES marketing_campaigns(id),
    abandoned_cart_id INTEGER REFERENCES abandoned_carts(id),
    message_type TEXT NOT NULL, -- 'email', 'sms', 'chat', 'push'
    recipient TEXT NOT NULL,
    subject TEXT,
    content TEXT NOT NULL,
    sent_at TIMESTAMP DEFAULT NOW(),
    delivery_status TEXT DEFAULT 'pending', -- 'pending', 'sent', 'delivered', 'failed'
    opened_at TIMESTAMP,
    clicked_at TIMESTAMP,
    converted BOOLEAN DEFAULT FALSE
);

-- Kedvezm√©ny k√≥dok gener√°l√°sa √©s tracking
CREATE TABLE discount_codes (
    id SERIAL PRIMARY KEY,
    code TEXT UNIQUE NOT NULL,
    customer_id TEXT,
    discount_percentage DECIMAL(5,2),
    discount_amount DECIMAL(10,2),
    minimum_order_value DECIMAL(10,2),
    valid_from TIMESTAMP DEFAULT NOW(),
    valid_until TIMESTAMP NOT NULL,
    usage_limit INTEGER DEFAULT 1,
    times_used INTEGER DEFAULT 0,
    created_for TEXT, -- 'abandoned_cart', 'loyalty', 'seasonal'
    active BOOLEAN DEFAULT TRUE
);

-- Indexek teljes√≠tm√©ny optimaliz√°l√°shoz
CREATE INDEX idx_abandoned_carts_customer_id ON abandoned_carts(customer_id);
CREATE INDEX idx_abandoned_carts_abandoned_at ON abandoned_carts(abandoned_at);
CREATE INDEX idx_abandoned_carts_returned ON abandoned_carts(returned);
CREATE INDEX idx_marketing_messages_sent_at ON marketing_messages(sent_at);
CREATE INDEX idx_discount_codes_customer_id ON discount_codes(customer_id);
```

---

## ‚öôÔ∏è **K√∂rnyezeti V√°ltoz√≥k √©s Konfigur√°ci√≥**

### **Environment Variables (.env friss√≠t√©s)**

```bash
# Marketing Automation Configuration
EMAIL_SERVICE_PROVIDER=sendgrid
EMAIL_API_KEY=your_sendgrid_api_key
EMAIL_FROM_ADDRESS=no-reply@yourwebshop.com
EMAIL_FROM_NAME=YourWebshop √úgyf√©lszolg√°lat

# SMS Configuration  
SMS_SERVICE_PROVIDER=twilio
TWILIO_ACCOUNT_SID=your_twilio_account_sid
TWILIO_AUTH_TOKEN=your_twilio_auth_token
TWILIO_PHONE_NUMBER=+36123456789

# Abandoned Cart Settings
ABANDONED_CART_TIMEOUT_MINUTES=30
FOLLOW_UP_EMAIL_DELAY_MINUTES=30
FOLLOW_UP_SMS_DELAY_HOURS=2
FINAL_OFFER_DELAY_HOURS=24
MINIMUM_CART_VALUE_FOR_FOLLOWUP=5000

# Discount Configuration
DEFAULT_DISCOUNT_PERCENTAGE=10
URGENT_DISCOUNT_PERCENTAGE=20
DISCOUNT_CODE_VALIDITY_DAYS=7
MAX_FOLLOW_UP_ATTEMPTS=3

# Background Tasks (Celery + Redis)
CELERY_BROKER_URL=redis://localhost:6379/1
CELERY_RESULT_BACKEND=redis://localhost:6379/1
CELERY_TIMEZONE=Europe/Budapest

# Template Configuration
EMAIL_TEMPLATE_DIR=templates/email/
SMS_TEMPLATE_DIR=templates/sms/
DEFAULT_LANGUAGE=hu
```

### **Requirements.txt Kieg√©sz√≠t√©sek**

```bash
# Marketing Automation & Messaging
sendgrid>=6.9.0
twilio>=8.2.0
jinja2>=3.1.0

# Background Task Processing
celery>=5.3.0
redis>=5.0.0
kombu>=5.3.0

# Email Template Rendering
premailer>=3.10.0  # CSS inlining for emails
html2text>=2020.1.16  # HTML to text conversion

# Analytics and Tracking
mixpanel>=4.9.0  # Optional: advanced analytics
segment-analytics-python>=2.2.0  # Optional: customer data platform
```

---

## üìä **Analytics √©s Monitoring**

### **Kamp√°ny Teljes√≠tm√©ny Metrik√°k**

```python
class MarketingAnalytics:
    """Marketing automation teljes√≠tm√©ny tracking"""
    
    async def get_abandoned_cart_stats(self, date_range: tuple) -> dict:
        """Kos√°relhagy√°s statisztik√°k"""
        stats = await self.supabase.rpc('get_abandoned_cart_stats', {
            'start_date': date_range[0],
            'end_date': date_range[1]
        }).execute()
        
        return {
            'total_abandoned_carts': stats.data['total_abandoned'],
            'total_abandoned_value': stats.data['total_value'],
            'follow_up_sent': stats.data['follow_ups_sent'],
            'return_rate': stats.data['return_rate'],
            'conversion_rate': stats.data['conversion_rate'],
            'recovered_revenue': stats.data['recovered_revenue']
        }
    
    async def get_email_campaign_performance(self, campaign_id: int) -> dict:
        """Email kamp√°ny teljes√≠tm√©ny"""
        performance = await self.supabase.table('marketing_messages').select('''
            COUNT(*) as sent_count,
            COUNT(opened_at) as opened_count,
            COUNT(clicked_at) as clicked_count,
            COUNT(CASE WHEN converted = true THEN 1 END) as converted_count
        ''').eq('campaign_id', campaign_id).execute()
        
        data = performance.data[0]
        
        return {
            'sent_count': data['sent_count'],
            'open_rate': (data['opened_count'] / data['sent_count']) * 100,
            'click_rate': (data['clicked_count'] / data['sent_count']) * 100,
            'conversion_rate': (data['converted_count'] / data['sent_count']) * 100
        }
```

### **Pydantic Logfire Integration**

```python
import logfire

# Marketing events logging
@logfire.instrument
async def log_abandoned_cart_event(cart_id: str, cart_value: float):
    logfire.info(
        "Abandoned cart detected",
        cart_id=cart_id,
        cart_value=cart_value,
        event_type="abandoned_cart"
    )

@logfire.instrument
async def log_follow_up_sent(cart_id: str, message_type: str, success: bool):
    logfire.info(
        "Follow-up message sent",
        cart_id=cart_id,
        message_type=message_type,
        success=success,
        event_type="follow_up_sent"
    )

@logfire.instrument  
async def log_cart_recovery(cart_id: str, recovered_value: float):
    logfire.info(
        "Cart recovered successfully",
        cart_id=cart_id,
        recovered_value=recovered_value,
        event_type="cart_recovered"
    )
```

---

## üé® **Email √©s SMS Sablonok**

### **HTML Email Sablon (Jinja2)**

```html
<!-- templates/email/abandoned_cart_reminder.html -->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ne felejtsd el a kosaradat!</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1 style="color: #2c3e50;">üõí Szia {{ customer_name }}!</h1>
        
        <p>√âszrevettem, hogy valami maradt a kosaradban. Ne hagyd, hogy elmenjanak ezek a nagyszer≈± term√©kek!</p>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h2>A kosaradban tal√°lhat√≥:</h2>
            {% for item in cart_items %}
            <div style="border-bottom: 1px solid #dee2e6; padding: 10px 0;">
                <strong>{{ item.name }}</strong><br>
                Mennyis√©g: {{ item.quantity }} db<br>
                √År: {{ item.price | number_format }} Ft
            </div>
            {% endfor %}
            
            <h3 style="color: #e74c3c; margin-top: 20px;">
                √ñsszesen: {{ cart_total }}
            </h3>
        </div>
        
        {% if discount_code %}
        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <strong>üéâ K√ºl√∂nleges aj√°nlat csak neked!</strong><br>
            Haszn√°ld a <strong>{{ discount_code }}</strong> k√≥dot √©s kapsz 10% kedvezm√©nyt!
        </div>
        {% endif %}
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="{{ return_url }}" style="background: #28a745; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">
                V√°s√°rl√°s befejez√©se 
            </a>
        </div>
        
        <p style="color: #6c757d; font-size: 14px;">
            Ha b√°rmilyen k√©rd√©sed van, √≠rj nek√ºnk vagy h√≠vd √ºgyf√©lszolg√°latunkat!<br>
            <strong>Chatbot:</strong> Azonnal v√°laszolok a webshopban<br>
            <strong>Telefon:</strong> +36 1 234 5678
        </p>
        
        <hr style="border: none; border-top: 1px solid #dee2e6; margin: 30px 0;">
        
        <p style="color: #6c757d; font-size: 12px;">
            Ha nem szeretn√©l t√∂bb ilyen emailt kapni, 
            <a href="{{ unsubscribe_url }}">iratkozz le itt</a>.
        </p>
    </div>
</body>
</html>
```

### **SMS Sablon**

```python
# templates/sms/abandoned_cart_sms.txt
"""
üõí Szia {{ customer_name }}! 

{{ cart_total }} √©rt√©kben maradt valami a kosaradban.

{% if discount_code %}
üéÅ Haszn√°ld a {{ discount_code }} k√≥dot 10% kedvezm√©ny√©rt!
{% endif %}

Befejez√©s: {{ short_url }}

YourWebshop csapata
"""
```

---

## üöÄ **Implement√°ci√≥s Roadmap**

### **Phase 1: Core Infrastructure (1-2 h√©t)**
- [x] Adatb√°zis schema l√©trehoz√°sa
- [x] Marketing Agent alapstrukt√∫ra
- [x] Background task system setup (Celery + Redis)
- [x] Email/SMS service integr√°ci√≥ alapok

### **Phase 2: Basic Automation (1 h√©t)**  
- [x] Abandoned cart detection algoritmus
- [x] Egyszer≈± email follow-up
- [x] Basic analytics √©s logging
- [x] Template engine setup

### **Phase 3: Advanced Features (1-2 h√©t)**
- [x] SMS integration
- [x] Personalized offers √©s discount codes
- [x] Multi-stage follow-up campaigns
- [x] A/B testing framework

### **Phase 4: Optimization & Analytics (1 h√©t)**
- [x] Advanced analytics dashboard
- [x] Performance monitoring
- [x] Campaign optimization
- [x] GDPR compliance audit

---

## üìà **V√°rhat√≥ Eredm√©nyek**

### **Industry Benchmarks:**
- **Email open rate**: 15-25% (e-commerce √°tlag)
- **Click-through rate**: 2-5%
- **Cart recovery rate**: 10-15%
- **ROI**: 300-500% az automation kamp√°nyokon

### **Optimaliz√°ci√≥s C√©lok:**
- **30% n√∂veked√©s** a kos√°r abandon rate cs√∂kkent√©s√©ben
- **20% n√∂veked√©s** az average order value-ban
- **15% n√∂veked√©s** a customer lifetime value-ban
- **50% cs√∂kkent√©s** a manual marketing tasks-okban

---

## üîí **GDPR Compliance √©s Adatv√©delem**

### **Adatv√©delmi Megfontol√°sok**
- **Explicit consent**: Email/SMS marketing hozz√°j√°rul√°s k√©r√©se
- **Right to be forgotten**: Unsubscribe √©s adat t√∂rl√©si lehet≈ës√©g
- **Data minimization**: Csak sz√ºks√©ges adatok t√°rol√°sa
- **Audit trail**: Minden marketing aktivit√°s napl√≥z√°sa

### **Compliance Implementation**
```python
class GDPRCompliantMarketing:
    async def check_marketing_consent(self, customer_id: str) -> bool:
        """Marketing hozz√°j√°rul√°s ellen≈ërz√©se"""
        consent = await self.supabase.table('customer_consents').select('*').eq('customer_id', customer_id).execute()
        return consent.data and consent.data[0].get('marketing_emails', False)
    
    async def process_unsubscribe(self, customer_id: str, token: str) -> bool:
        """Leiratkoz√°s feldolgoz√°sa"""
        # Token valid√°ci√≥
        # Marketing consent visszavon√°sa
        # Audit log bejegyz√©s
        pass
    
    async def delete_customer_marketing_data(self, customer_id: str) -> bool:
        """√úgyf√©l marketing adatok t√∂rl√©se (GDPR right to be forgotten)"""
        # Abandoned carts t√∂rl√©se
        # Marketing messages t√∂rl√©se  
        # Discount codes deaktiv√°l√°sa
        # Audit log bejegyz√©s
        pass
```

---

## üéØ **K√∂vetkez≈ë L√©p√©sek**

1. **‚úÖ Dokument√°ci√≥ elk√©sz√ºlt**
2. **üîÑ Adatb√°zis schema implement√°l√°sa**
3. **üîÑ Email service (SendGrid) be√°ll√≠t√°sa**
4. **üîÑ SMS service (Twilio) be√°ll√≠t√°sa**
5. **üîÑ Celery background tasks konfigur√°l√°sa**
6. **üîÑ Marketing Agent fejleszt√©se**
7. **üîÑ Email/SMS template engine**
8. **üîÑ Analytics dashboard l√©trehoz√°sa**

**üöÄ A marketing automation funkci√≥ hozz√°ad√°s√°val a Chatbuddy MVP egy teljes k√∂r≈± e-commerce marketing platformm√° v√°lik, amely automatikusan n√∂veli a konverzi√≥s r√°t√°kat √©s jav√≠tja a customer experience-t!**